<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Frontend Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .streaming-output {
            background-color: #e8f5e8;
            border: 1px solid #c3e6c3;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .inline-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .inline-form input {
            flex: 1;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-unknown { background-color: #6c757d; }
    </style>
</head>
<body>
    <h1>Investment Portfolio Backend API Test Interface</h1>
    
    <div class="container">
        <h2>Server Status</h2>
        <div id="serverStatus">
            <p><span class="status-indicator status-unknown"></span>Frontend (Next.js): <span id="frontendStatus">Checking...</span></p>
            <p><span class="status-indicator status-unknown"></span>Backend (FastAPI): <span id="backendStatus">Checking...</span></p>
        </div>
        <button onclick="checkServerStatus()">Refresh Status</button>
    </div>
    
    <div class="container">
        <h2>1. Test Basic Connectivity</h2>
        <button onclick="testConnection()">Test Backend Connection</button>
        <div id="connectionOutput" class="output" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>2. Generate Investment Report (Demo Data)</h2>
        <p><em>Uses enhanced test data matching frontend structure</em></p>
        <button onclick="generateReport()">Generate Report</button>
        <div id="reportOutput" class="output" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>3. Test Streaming Report Generation</h2>
        <button onclick="testStreamingReport()" id="streamButton">Start Streaming Report</button>
        <button onclick="stopStreaming()" id="stopButton" disabled>Stop Streaming</button>
        <div id="streamingOutput" class="output streaming-output" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>4. Custom Portfolio Assessment</h2>
        <div class="form-group">
            <label for="portfolioType">Portfolio Type:</label>
            <select id="portfolioType">
                <option value="balanced">Balanced</option>
                <option value="aggressive">Aggressive Growth</option>
                <option value="conservative">Conservative</option>
                <option value="income">Income Focused</option>
            </select>
        </div>
        <div class="form-group">
            <label for="riskTolerance">Risk Tolerance (1-10):</label>
            <input type="text" id="riskTolerance" value="5" placeholder="Enter risk tolerance (1-10)">
        </div>
        <div class="form-group">
            <label for="investmentAmount">Investment Amount:</label>
            <input type="text" id="investmentAmount" value="100000" placeholder="Enter investment amount">
        </div>
        <div class="form-group">
            <label for="investmentGoals">Investment Goals:</label>
            <textarea id="investmentGoals" placeholder="Describe your investment goals...">Long-term wealth building and retirement planning</textarea>
        </div>
        <button onclick="generateCustomReport()">Generate Custom Report</button>
        <div id="customReportOutput" class="output" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const FRONTEND_BASE = 'http://localhost:3000';
        let streamController = null;

        // Check server status on page load
        window.addEventListener('load', checkServerStatus);

        // Check server status
        async function checkServerStatus() {
            // Check Frontend
            try {
                const frontendResponse = await fetch(FRONTEND_BASE, { method: 'HEAD' });
                if (frontendResponse.ok) {
                    updateStatus('frontend', true, 'Running on port 3000');
                } else {
                    updateStatus('frontend', false, 'Not responding');
                }
            } catch (error) {
                updateStatus('frontend', false, 'Connection failed');
            }

            // Check Backend
            try {
                const backendResponse = await fetch(`${API_BASE}/`);
                const data = await backendResponse.json();
                if (data.status === 'running') {
                    updateStatus('backend', true, 'Running on port 8000');
                } else {
                    updateStatus('backend', false, 'Unexpected response');
                }
            } catch (error) {
                updateStatus('backend', false, 'Connection failed');
            }
        }

        function updateStatus(server, isRunning, message) {
            const statusElement = document.getElementById(`${server}Status`);
            const indicator = statusElement.parentElement.querySelector('.status-indicator');
            
            statusElement.textContent = message;
            indicator.className = `status-indicator ${isRunning ? 'status-running' : 'status-error'}`;
        }

        // Test basic connectivity
        async function testConnection() {
            const output = document.getElementById('connectionOutput');
            output.style.display = 'block';
            output.textContent = 'Testing connection...';
            output.className = 'output';
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                output.textContent = `✅ Connection successful!\nResponse: ${JSON.stringify(data, null, 2)}`;
                output.className = 'output success';
            } catch (error) {
                output.textContent = `❌ Connection failed!\nError: ${error.message}`;
                output.className = 'output error';
            }
        }

        // Test report generation using enhanced demo data
        async function generateReport() {
            const output = document.getElementById('reportOutput');
            output.style.display = 'block';
            output.textContent = 'Generating report with enhanced demo data...';
            output.className = 'output';
            
            try {
                // Use the enhanced test data structure from test_streaming_api.py
                const response = await fetch(`${API_BASE}/api/generate-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_data: {
                            personal_info: {
                                name: "Sarah Johnson",
                                age: 34,
                                email: "sarah.j@email.com",
                                phone: "+1-555-0123"
                            },
                            risk_profile: {
                                risk_tolerance: 7,
                                risk_capacity: 8,
                                investment_experience: "intermediate"
                            },
                            financial_situation: {
                                annual_income: 120000,
                                net_worth: 450000,
                                liquid_assets: 85000,
                                monthly_expenses: 6500
                            },
                            goals: [
                                {
                                    id: "retirement",
                                    label: "Retirement Planning",
                                    target_amount: 2000000,
                                    time_horizon_years: 30,
                                    priority: "high"
                                },
                                {
                                    id: "house",
                                    label: "Home Purchase",
                                    target_amount: 150000,
                                    time_horizon_years: 5,
                                    priority: "medium"
                                }
                            ],
                            investment_preferences: {
                                preferred_asset_classes: ["stocks", "bonds", "real_estate"],
                                esg_preference: true,
                                international_exposure: 0.3
                            }
                        }
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success' && data.report.pdf_available) {
                    // Show success message with report details
                    output.textContent = `✅ Enhanced report generated successfully!\n\nReport Details:\n- Title: ${data.report.report_title}\n- Type: ${data.report.report_type}\n- Generated: ${data.report.generated_date}\n- PDF Location: ${data.report.pdf_filename}\n\nClient Profile:\n- Risk Profile: ${data.report.client_profile.risk_profile}\n- Investment Timeline: ${data.report.client_profile.investment_timeline}\n- ESG Integration: ${data.report.client_profile.esg_integration}\n\nHouse View:\n- Investment Stance: ${data.report.house_view_summary.investment_stance}\n- Central Theme: ${data.report.house_view_summary.central_theme}\n\nUsed enhanced data structure matching frontend UserProfile interface.`;
                    output.className = 'output success';
                } else {
                    throw new Error(data.message || 'Report generation failed');
                }
            } catch (error) {
                output.textContent = `❌ Report generation failed!\nError: ${error.message}`;
                output.className = 'output error';
            }
        }

        // Test streaming report generation
        async function testStreamingReport() {
            const output = document.getElementById('streamingOutput');
            const streamButton = document.getElementById('streamButton');
            const stopButton = document.getElementById('stopButton');
            
            output.style.display = 'block';
            output.textContent = 'Starting streaming report generation...\n';
            output.className = 'output streaming-output';
            
            streamButton.disabled = true;
            stopButton.disabled = false;
            
            try {
                streamController = new AbortController();
                
                // Use enhanced data structure for streaming
                const response = await fetch(`${API_BASE}/api/generate-report/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_data: {
                            personal_info: {
                                name: "Michael Chen",
                                age: 28,
                                email: "michael.c@email.com",
                                phone: "+1-555-0456"
                            },
                            risk_profile: {
                                risk_tolerance: 6,
                                risk_capacity: 7,
                                investment_experience: "beginner"
                            },
                            financial_situation: {
                                annual_income: 75000,
                                net_worth: 125000,
                                liquid_assets: 35000,
                                monthly_expenses: 4200
                            },
                            goals: [
                                {
                                    id: "growth",
                                    label: "Wealth Building",
                                    target_amount: 500000,
                                    time_horizon_years: 15,
                                    priority: "high"
                                }
                            ],
                            investment_preferences: {
                                preferred_asset_classes: ["stocks", "bonds"],
                                esg_preference: false,
                                international_exposure: 0.2
                            }
                        }
                    }),
                    signal: streamController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                output.textContent += '\n✅ Streaming completed successfully!';
                                break;
                            }
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content) {
                                    output.textContent += parsed.content;
                                }
                                if (parsed.status) {
                                    output.textContent += `\n[Status: ${parsed.status}]\n`;
                                }
                            } catch (e) {
                                // Handle non-JSON data
                                output.textContent += data;
                            }
                        }
                    }
                    
                    // Auto-scroll to bottom
                    output.scrollTop = output.scrollHeight;
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    output.textContent += '\n⏹️ Streaming stopped by user.';
                } else {
                    output.textContent += `\n❌ Streaming failed: ${error.message}`;
                    output.className = 'output error';
                }
            } finally {
                streamButton.disabled = false;
                stopButton.disabled = true;
                streamController = null;
            }
        }

        // Stop streaming
        function stopStreaming() {
            if (streamController) {
                streamController.abort();
            }
        }

        // Generate custom report with enhanced data structure
        async function generateCustomReport() {
            const output = document.getElementById('customReportOutput');
            const portfolioType = document.getElementById('portfolioType').value;
            const riskTolerance = parseInt(document.getElementById('riskTolerance').value);
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
            const investmentGoals = document.getElementById('investmentGoals').value;
            
            output.style.display = 'block';
            output.textContent = 'Generating custom report...';
            output.className = 'output';
            
            if (isNaN(riskTolerance) || riskTolerance < 1 || riskTolerance > 10) {
                output.textContent = '❌ Risk tolerance must be a number between 1 and 10';
                output.className = 'output error';
                return;
            }
            
            if (isNaN(investmentAmount) || investmentAmount <= 0) {
                output.textContent = '❌ Investment amount must be a positive number';
                output.className = 'output error';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/generate-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_data: {
                            personal_info: {
                                name: "Custom User",
                                age: 30,
                                email: "custom@email.com",
                                phone: "+1-555-XXXX"
                            },
                            risk_profile: {
                                risk_tolerance: riskTolerance,
                                risk_capacity: Math.min(riskTolerance + 1, 10),
                                investment_experience: riskTolerance > 6 ? "intermediate" : "beginner"
                            },
                            financial_situation: {
                                annual_income: Math.round(investmentAmount * 0.6),
                                net_worth: investmentAmount,
                                liquid_assets: Math.round(investmentAmount * 0.8),
                                monthly_expenses: Math.round(investmentAmount * 0.03)
                            },
                            goals: [
                                {
                                    id: portfolioType,
                                    label: portfolioType.charAt(0).toUpperCase() + portfolioType.slice(1),
                                    target_amount: investmentAmount * 3,
                                    time_horizon_years: riskTolerance > 6 ? 20 : 10,
                                    priority: "high"
                                }
                            ],
                            investment_preferences: {
                                preferred_asset_classes: portfolioType === "conservative" ? ["bonds", "stocks"] : ["stocks", "bonds"],
                                esg_preference: false,
                                international_exposure: portfolioType === "aggressive" ? 0.4 : 0.2
                            },
                            milestones: [
                                {
                                    year: 5,
                                    target_amount: investmentAmount * 1.5,
                                    description: `Mid-term ${portfolioType} milestone`
                                }
                            ],
                            values: [
                                {
                                    id: "growth",
                                    importance: portfolioType === "aggressive" ? "high" : "medium"
                                },
                                {
                                    id: "security", 
                                    importance: portfolioType === "conservative" ? "high" : "medium"
                                }
                            ]
                        }
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success' && data.report.pdf_available) {
                    output.textContent = `✅ Custom ${portfolioType} report generated!\n\nInput Parameters:\n- Risk Tolerance: ${riskTolerance}/10\n- Investment Amount: $${investmentAmount.toLocaleString()}\n- Portfolio Type: ${portfolioType}\n\nGenerated Report:\n- Title: ${data.report.report_title}\n- Type: ${data.report.report_type}\n- Generated: ${data.report.generated_date}\n- PDF Location: ${data.report.pdf_filename}\n\nClient Analysis:\n- Risk Profile: ${data.report.client_profile.risk_profile}\n- Investment Timeline: ${data.report.client_profile.investment_timeline}\n- Monthly Capacity: ${data.report.client_profile.monthly_investment_capacity}\n\nUsed enhanced data structure with goals, milestones, and values.`;
                    output.className = 'output success';
                } else {
                    throw new Error(data.message || 'Custom report generation failed');
                }
            } catch (error) {
                output.textContent = `❌ Custom report generation failed!\nError: ${error.message}`;
                output.className = 'output error';
            }
        }
    </script>
</body>
</html>